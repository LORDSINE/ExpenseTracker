{% extends "base.html" %}

{% block title %}Analytics - Expense Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-bar"></i> Financial Analytics
        </h1>
    </div>
</div>

<!-- Income by Category -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Income by Category</h5>
            </div>
            <div class="card-body">
                {% if income_by_category %}
                    <canvas id="incomeChart" width="400" height="200"></canvas>
                    <div class="mt-3">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category, total in income_by_category %}
                                <tr>
                                    <td>{{ category.replace('_', ' ').title() }}</td>
                                    <td class="income">${{ "%.2f"|format(total) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">No income data available</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Expense by Category -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Expenses by Category</h5>
            </div>
            <div class="card-body">
                {% if expense_by_category %}
                    <canvas id="expenseChart" width="400" height="200"></canvas>
                    <div class="mt-3">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category, total in expense_by_category %}
                                <tr>
                                    <td>{{ category.replace('_', ' ').title() }}</td>
                                    <td class="expense">${{ "%.2f"|format(total) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">No expense data available</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Monthly Trends -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Monthly Trends</h5>
            </div>
            <div class="card-body">
                {% if monthly_data %}
                    <canvas id="monthlyChart" width="400" height="200"></canvas>
                {% else %}
                    <p class="text-muted text-center">No monthly data available</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Income Chart
{% if income_by_category %}
const incomeCtx = document.getElementById('incomeChart').getContext('2d');
const incomeData = {
    labels: [{% for category, total in income_by_category %}'{{ category.replace("_", " ").title() }}'{{ "," if not loop.last }}{% endfor %}],
    datasets: [{
        data: [{% for category, total in income_by_category %}{{ total }}{{ "," if not loop.last }}{% endfor %}],
        backgroundColor: [
            '#28a745', '#17a2b8', '#ffc107', '#6f42c1', 
            '#e83e8c', '#fd7e14', '#20c997', '#6c757d'
        ]
    }]
};

new Chart(incomeCtx, {
    type: 'doughnut',
    data: incomeData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});
{% endif %}

// Expense Chart
{% if expense_by_category %}
const expenseCtx = document.getElementById('expenseChart').getContext('2d');
const expenseData = {
    labels: [{% for category, total in expense_by_category %}'{{ category.replace("_", " ").title() }}'{{ "," if not loop.last }}{% endfor %}],
    datasets: [{
        data: [{% for category, total in expense_by_category %}{{ total }}{{ "," if not loop.last }}{% endfor %}],
        backgroundColor: [
            '#dc3545', '#fd7e14', '#ffc107', '#17a2b8',
            '#6f42c1', '#e83e8c', '#20c997', '#6c757d'
        ]
    }]
};

new Chart(expenseCtx, {
    type: 'doughnut',
    data: expenseData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});
{% endif %}

// Monthly Trends Chart
{% if monthly_data %}
// Process monthly data
const monthlyProcessed = {};
{% for month, type, total in monthly_data %}
if (!monthlyProcessed['{{ month }}']) {
    monthlyProcessed['{{ month }}'] = {income: 0, expense: 0};
}
monthlyProcessed['{{ month }}']['{{ type }}'] = {{ total }};
{% endfor %}

const months = Object.keys(monthlyProcessed).sort();
const incomeData = months.map(month => monthlyProcessed[month].income || 0);
const expenseData = months.map(month => monthlyProcessed[month].expense || 0);

const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
new Chart(monthlyCtx, {
    type: 'line',
    data: {
        labels: months,
        datasets: [{
            label: 'Income',
            data: incomeData,
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.1
        }, {
            label: 'Expenses',
            data: expenseData,
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toFixed(2);
                    }
                }
            }
        },
        plugins: {
            legend: {
                position: 'top',
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
